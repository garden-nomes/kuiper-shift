import{T as t,a as e,V as i,i as s,s as h,S as a}from"./vendor.f2959f89.js";!function(t=".",e="__import__"){try{self[e]=new Function("u","return import(u)")}catch(i){const s=new URL(t,location),h=t=>{URL.revokeObjectURL(t.src),t.remove()};self[e]=t=>new Promise(((i,a)=>{const r=new URL(t,s);if(self[e].moduleMap[r])return i(self[e].moduleMap[r]);const n=new Blob([`import * as m from '${r}';`,`${e}.moduleMap['${r}']=m;`],{type:"text/javascript"}),l=Object.assign(document.createElement("script"),{type:"module",src:URL.createObjectURL(n),onerror(){a(new Error(`Failed to import: ${t}`)),h(l)},onload(){i(self[e].moduleMap[r]),h(l)}});document.head.appendChild(l)})),self[e].moduleMap={}}}("/tiny-asteroid-miner/assets/");const r={calendar:[{x:0,y:0,w:3,h:4}],frame:[{x:0,y:4,w:84,h:48}],hatch:[{x:0,y:52,w:8,h:5},{x:8,y:52,w:8,h:5},{x:16,y:52,w:8,h:5}],miner:[{x:0,y:57,w:8,h:8},{x:8,y:57,w:8,h:8},{x:16,y:57,w:8,h:8}],pot:[{x:0,y:65,w:6,h:3},{x:6,y:65,w:6,h:3}],screen:[{x:0,y:68,w:7,h:5}],title:[{x:0,y:73,w:28,h:12}]},n={"blip-0":[0,.12632653061224489],"blip-2":[2,2.0401814058956917],crash:[4,4.4852380952380955],laser:[6,6.333854875283446],notice:[8,8.146281179138322],off:[10,10.146281179138322],on:[12,12.205736961451247],rumble:[14,14.545986394557824],sleep:[16,16.355034013605444],theme:[18,57.5744671201814],thud:[59,59.40761904761905],wake:[61,61.40761904761905]};var l,o,d,c,u,m;function w(t,e,i,s){const h=l.sub(i,t),a=l.dot(h,e);if(a<0)return null;const r=Math.sqrt(l.magSq(h)-a*a);if(r>s)return null;return a-Math.sqrt(s*s-r*r)}(o=l||(l={})).dot=function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]},o.add=function(t,e){return[t[0]+e[0],t[1]+e[1],t[2]+e[2]]},o.sub=function(t,e){return[t[0]-e[0],t[1]-e[1],t[2]-e[2]]},o.magSq=function(t){return t[0]*t[0]+t[1]*t[1]+t[2]*t[2]},o.mag=function(t){return Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2])},o.scale=function(t,e){return[t[0]*e,t[1]*e,t[2]*e]},o.normalize=function(t){const e=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]);return 0===e?[0,0,1]:[t[0]/e,t[1]/e,t[2]/e]},(c=d||(d={})).mult3x3=function(t,e){return[[t[0][0]*e[0][0]+t[0][1]*e[1][0]+t[0][2]*e[2][0],t[0][0]*e[0][1]+t[0][1]*e[1][1]+t[0][2]*e[2][1],t[0][0]*e[0][2]+t[0][1]*e[1][2]+t[0][2]*e[2][2]],[t[1][0]*e[0][0]+t[1][1]*e[1][0]+t[1][2]*e[2][0],t[1][0]*e[0][1]+t[1][1]*e[1][1]+t[1][2]*e[2][1],t[1][0]*e[0][2]+t[1][1]*e[1][2]+t[1][2]*e[2][2]],[t[2][0]*e[0][0]+t[2][1]*e[1][0]+t[2][2]*e[2][0],t[2][0]*e[0][1]+t[2][1]*e[1][1]+t[2][2]*e[2][1],t[2][0]*e[0][2]+t[2][1]*e[1][2]+t[2][2]*e[2][2]]]},c.mult3x3vec=function(t,e){return[t[0][0]*e[0]+t[1][0]*e[1]+t[2][0]*e[2],t[0][1]*e[0]+t[1][1]*e[1]+t[2][1]*e[2],t[0][2]*e[0]+t[1][2]*e[1]+t[2][2]*e[2]]},c.roll=function(t){const e=Math.cos(t),i=Math.sin(t);return[[e,-i,0],[i,e,0],[0,0,1]]},c.yaw=function(t){const e=Math.cos(t),i=Math.sin(t);return[[e,0,i],[0,1,0],[-i,0,e]]},c.pitch=function(t){const e=Math.cos(t),i=Math.sin(t);return[[1,0,0],[0,e,-i],[0,i,e]]};class g{constructor(t,e,i){this.s=i,this.m=[[e[0][0],e[1][0],e[2][0],0],[e[0][1],e[1][1],e[2][1],0],[e[0][2],e[1][2],e[2][2],0],[-l.dot(e[0],t),-l.dot(e[1],t),-l.dot(e[2],t),1]]}projectToScreen(t){const e=this.m[0][0]*t[0]+this.m[1][0]*t[1]+this.m[2][0]*t[2]+this.m[3][0],i=this.m[0][1]*t[0]+this.m[1][1]*t[1]+this.m[2][1]*t[2]+this.m[3][1],s=this.m[0][2]*t[0]+this.m[1][2]*t[1]+this.m[2][2]*t[2]+this.m[3][2];return[e*this.s/s+p.width/2,i*-this.s/s+p.height/2,s/this.s]}}(m=u||(u={}))[m.Accelerating=0]="Accelerating",m[m.Braking=1]="Braking",m[m.Idle=2]="Idle";class f{constructor(){this.rot=[[1,0,0],[0,1,0],[0,0,1]],this.pos=[0,0,0],this.vel=[0,0,0],this.hasControl=!1,this.miningDistance=.6,this.asteroidShrinkRate=.1,this.miningRate=50,this.state=2,this.ore=0,this.credits=0,this.onDamage=()=>{},this.hullIntegrity=1,this.isBrakingEnabled=!0}update(){if(this.state=2,this.hullIntegrity>0){if(this.hasControl&&(p.keyDown("left")&&this.turn(0,p.deltaTime),p.keyDown("right")&&this.turn(0,-p.deltaTime),p.keyDown("up")&&this.turn(p.deltaTime,0),p.keyDown("down")&&this.turn(-p.deltaTime,0),p.keyDown("z")&&this.thrust([0,0,p.deltaTime]),p.keyDown("x")&&this.thrust([0,0,-p.deltaTime])),(p.keyDown("z")||p.keyDown("x"))&&this.hasControl)this.state=0;else if(this.isBrakingEnabled){if(l.mag(this.vel)>.001){this.state=1;const t=-Math.min(p.deltaTime,l.mag(this.vel)),e=l.scale(l.normalize(this.vel),t);this.vel=l.add(e,this.vel)}else this.vel=[0,0,0]}}else this.vel=l.scale(l.normalize(this.vel),.5);this.pos=l.add(this.pos,l.scale(this.vel,p.deltaTime))}mine(t){t.radius-=p.deltaTime*this.asteroidShrinkRate,this.ore+=p.deltaTime*this.miningRate,this.ore=Math.min(this.ore,1e3)}turn(t,e){this.rot=d.mult3x3(d.pitch(t),d.mult3x3(d.yaw(e),this.rot))}thrust(t){this.vel=l.add(this.vel,d.mult3x3vec(this.rot,t))}collideWithAsteroid(t){const e=l.sub(this.pos,t.pos);this.pos=l.add(t.pos,l.scale(l.normalize(e),t.radius+1e-4)),this.vel=l.sub(this.vel,l.scale(e,2*l.dot(this.vel,e)/l.magSq(e)));const i=Math.min(.5*l.mag(this.vel),.4+.1*Math.random());this.hullIntegrity-=i,this.onDamage()}get speed(){return l.mag(this.vel)}get forward(){return d.mult3x3vec(this.rot,[0,0,1])}get isMoving(){return l.magSq(this.vel)>0}}class x{constructor(){this.x=2,this.flip=!1,this.walkAnimTimer=0,this.hasControl=!0,this.heldPlant=null,this.wateringPlant=null,this.moveRightOverride=!1}update(){const t=this.x;if(this.wateringPlant){const t=this.x<this.wateringPlant.x?~~this.wateringPlant.x-5:4+~~this.wateringPlant.x;if(Math.abs(this.x-t)<1e-4)this.x=t,this.flip=this.wateringPlant.x<this.x,this.wateringPlant.hydration=1,this.wateringPlant=null;else{const e=t-this.x,i=32*p.deltaTime*(e<0?-1:1);this.x+=Math.abs(i)<Math.abs(e)?i:e}}else this.hasControl&&(p.keyDown("left")&&(this.x-=32*p.deltaTime),p.keyDown("right")&&(this.x+=32*p.deltaTime),this.x=Math.min(Math.max(this.x,1),p.width-2));this.moveRightOverride&&(this.x+=32*p.deltaTime),t!==this.x?(this.x-t<0&&(this.flip=!0),this.x-t>0&&(this.flip=!1),this.walkAnimTimer+=p.deltaTime):this.walkAnimTimer=0,this.heldPlant&&(this.heldPlant.x=this.flip?this.x-3:this.x+4,this.heldPlant.x=Math.min(Math.max(this.heldPlant.x,2),p.width-2),p.keyPressed("up")&&this.heldPlant.moveUp(),p.keyPressed("down")&&this.heldPlant.moveDown())}draw(){const t=this.walkAnimTimer>0?Math.floor(8*this.walkAnimTimer)%(r.miner.length-1)+1:0,e=r.miner[t];p.sprite(this.x-e.w/2,p.height-e.h,e,{flipX:this.flip})}}const y=[199,240,216],v=[67,82,61];class T{constructor(t){this.pos=t,this.radius=.5*Math.random()}draw(t,e){const[i,s,h]=t.projectToScreen(this.pos);if(h>0){const t=this.radius/(h+1e-4);i+t>0&&i-t<p.width&&s+t>0&&s-t<p.height&&p.circle(i,s,t,{color:e?v:y,depth:-h})}}}const M={bed:{x:1,w:10,h:3},bedShelf:{x:3,w:9,h:7},workbench:{x:22,w:10,h:4},console:{x:37,w:11,h:14},chair:{x:54,w:4,h:3},table:{x:59,w:9,h:5},shelves:{x:71,w:10,h:[3,9,12]}};var S,k,P,A,b,I;(k=S||(S={})).Forward="f",k.Move="m",k.Turn="t",k.TurnUpwards="tu",k.PushState="pu",k.PopState="po",k.SetColor="c",(A=P||(P={})).Apex="a",A.Internode="i",A.Bud="k",A.Branch="b";class C{constructor(){this.sequence=[[P.Apex,0]],this.age=0,this.cachedRendering=null,this.cachedRendingBounds=null,this.endBranching=2*Math.random()+4,this.endGrowth=5*Math.random()+2,this.growthRate=.01*Math.random(),this.d1=2*-Math.random()-1,this.d2=2*-Math.random()-1,this.l1=.5*Math.random()+.25,this.l2=.5*Math.random()+.25}iterate(t){const e=[];this.age+=t,this.ageNodes(t);for(const i of this.sequence)i[0]===P.Apex&&i[1]>0&&this.age<this.endBranching?e.push([P.Internode,this.l1],[S.PushState],[P.Branch,1],[P.Apex,this.d1*Math.random()+t],[S.PopState],[S.PushState],[P.Branch,-1],[P.Apex,this.d2*Math.random()+t],[S.PopState],[P.Internode,this.l2]):"i"===i[0]&&this.age<this.endGrowth?e.push([P.Internode,i[1]+t*this.growthRate]):e.push(i);this.sequence=e,this.updateLines()}ageNodes(t){this.sequence=this.sequence.map((e=>e[0]===P.Apex?[P.Apex,e[1]+t]:e))}interpret(){const t=[],e=Math.min(this.age/3,1)*(1/12),i=.5*Math.min(this.age/1.5,1)+1;for(const s of this.sequence)if(s[0]===P.Apex)t.push([S.SetColor,y],[S.Forward,1]);else if(s[0]===P.Internode){t.push([S.SetColor,v]);for(let e=0;e<5;e++)t.push([S.Forward,s[1]*i/5],[S.TurnUpwards,.01])}else s[0]===P.Branch?t.push([S.Turn,e*s[1]]):t.push(s);return t}updateLines(){const t=function(t,e,i,s=1){let h=v,a=-Math.PI/2;const r=[],n=[];for(const l of t)if(l[0]===S.Forward){const t=l[1],[r,o]=[e+Math.cos(a)*t*s,i+Math.sin(a)*t*s];n.push([e,i,r,o,h]),[e,i]=[r,o]}else if(l[0]===S.Move){const t=l[1];[e,i]=[e+Math.cos(a)*t*s,i+Math.sin(a)*t*s]}else if(l[0]===S.Turn)a-=2*Math.PI*l[1];else if(l[0]===S.TurnUpwards)a-=2*Math.PI*l[1]*(Math.cos(a)>0?1:-1);else if(l[0]===S.PushState)r.push([e,i,a]);else if(l[0]===S.PopState){if(0===r.length)throw new Error("No pushed state to retreive");[e,i,a]=r.pop()}else l[0]===S.SetColor&&(h=l[1]);return n}(this.interpret(),0,0);for(const n of t)n[0]=Math.round(n[0]),n[1]=Math.round(n[1]),n[2]=Math.round(n[2]),n[3]=Math.round(n[3]);let e=Number.POSITIVE_INFINITY,i=Number.NEGATIVE_INFINITY,s=Number.POSITIVE_INFINITY,h=Number.NEGATIVE_INFINITY;for(const[n,l,o,d]of t)n<e&&(e=o),n>i&&(i=o),l<s&&(s=d),l>h&&(h=d),o<e&&(e=o),o>i&&(i=o),d<s&&(s=d),d>h&&(h=d);const a=Math.ceil(i-e),r=Math.ceil(h-s);this.cachedRendering=new Uint8Array(a*r);for(const[n,l,o,d,c]of t){const t=c[0]===y[0]?2:1,i=(l-s)*a+(n-e),h=(d-s)*a+(o-e);this.cachedRendering[i]=t,this.cachedRendering[h]=t}this.cachedRendingBounds=[e,s,a,r]}draw(t,e,i){if(!this.cachedRendering)return;const[s,h,a,r]=this.cachedRendingBounds;for(let n=0;n<this.cachedRendering.length;n++)if(this.cachedRendering[n]>0){const r=t+s+n%a,l=e+h+~~(n/a),o=i||(2===this.cachedRendering[n]?v:y);p.pixel(r+1,l,o),p.pixel(r-1,l,o),p.pixel(r,l+1,o),p.pixel(r,l-1,o)}for(let n=0;n<this.cachedRendering.length;n++)if(this.cachedRendering[n]>0){const i=t+s+n%a,r=e+h+~~(n/a),l=1===this.cachedRendering[n]?v:y;p.pixel(i,r,l)}}}(I=b||(b={}))[I.Happy=0]="Happy",I[I.Thirsty=1]="Thirsty";class O{constructor(t){this.x=0,this.highlight=!1,this.hydration=.5,this.lastYPlacement=0,this.system=new C,this.systemUpdateInterval=.5,this.updateTimer=0,this.waterTimer=0,this.growthRate=.05,this.dehydrationRate=.01,this.waterParticles=[],this.dripSeconds=5;for(let e=0;e<50;e++){const[e,i]=this.findInitialPlacement();t.some((t=>Math.abs(t.x-e)<4&&Math.abs(t.y-i)<1e-4))&&e<49||(this.x=e,this.lastYPlacement=i)}}findInitialPlacement(){const{bedShelf:t,workbench:e,table:i,shelves:s}=M,h=t.w+e.w+i.w+2*s.w;let a=Math.random()*h;for(const r of[t,e,i]){if(a<r.w)return[r.x+a,48-r.h];a-=r.w}return a<s.w?[s.x+a,48-s.h[0]]:(a-=s.w,[s.x+a,48-s.h[1]])}update(){this.hydration-=p.deltaTime*this.dehydrationRate,this.hydration=Math.min(Math.max(this.hydration,0),1),this.updateTimer+=this.growthRate*p.deltaTime*this.hydration*2,this.updateTimer>this.systemUpdateInterval&&(this.system.iterate(this.updateTimer),this.updateTimer=0),this.hydration>1-this.dripSeconds*this.dehydrationRate?(this.waterTimer+=p.deltaTime,this.waterTimer>.2&&(this.waterTimer=0,this.waterParticles.push([this.x,this.y-4,Math.random()>.5?-1:1]))):this.waterTimer=0;for(const t of this.waterParticles)~~t[0]>~~this.x-3&&~~t[0]<2+~~this.x?t[0]+=10*t[2]*p.deltaTime:t[1]+=10*p.deltaTime;for(let t=0;t<this.waterParticles.length;t++)this.waterParticles[t][1]>p.height&&(this.waterParticles.splice(t,1),t--)}moveUp(){const t=this.possiblePlacements;let e=t.indexOf(this.placement);e=Math.min(e+1,t.length-1),this.lastYPlacement=t[e]}moveDown(){const t=this.possiblePlacements;let e=t.indexOf(this.placement);e=Math.max(e-1,0),this.lastYPlacement=t[e]}get placement(){const t=this.possiblePlacements;let e=t[0];for(const i of t)Math.abs(i-this.lastYPlacement)<Math.abs(e-this.lastYPlacement)&&(e=i);return e}get possiblePlacements(){const{workbench:t,table:e,bedShelf:i,shelves:s,chair:h}=M,a=[];this.x>s.x&&this.x<s.x+s.w?a.push(...s.h.map((t=>p.height-t))):a.push(p.height);for(const{x:r,w:n,h:l}of[t,e,h,i])this.x>r&&this.x<r+n&&a.push(p.height-l);return a}get y(){return this.placement}state(){return this.hydration<.5?1:0}water(){this.hydration+=1,this.hydration=Math.min(this.hydration,1.5)}draw(){const t=p.frame%10<5;this.highlight?this.system.draw(this.x,this.y-3,t?y:v):this.system.draw(this.x,this.y-3);const e=r.pot[this.highlight&&t?1:0];p.sprite(this.x-e.w/2,this.y-e.h,e);for(const[i,s]of this.waterParticles){const t=p.frame%2==0?y:v;p.pixel(i,s,t)}}}class R{constructor(t){this.pos=t,this.lifespan=.3*Math.random(),this.isDead=!1,this.vel=[Math.random()-.5,Math.random()-.5,Math.random()-.5],this.vel=l.scale(l.normalize(this.vel),2)}update(){this.lifespan-=p.deltaTime,this.lifespan<=0&&(this.isDead=!0),this.vel=l.scale(this.vel,.95),this.pos=l.add(this.pos,l.scale(this.vel,p.deltaTime))}draw(t){const[e,i,s]=t.projectToScreen(this.pos),[h,a]=t.projectToScreen(l.add(this.pos,l.scale(this.vel,.01)));if(s>0){const t=p.frame%2==0?y:v;p.line(e,i,h,a,t)}}}class B{constructor(){this.text=[]}draw(){if(this.text){let e=6;for(const i of this.text){if(!i){e+=3;continue}const s=p.textWidth(i);p.rect(p.width/2-Math.floor(s/2)-1,e-1,s+2,7,v),p.text(i,p.width/2,e,{color:y,align:t.Center}),e+=6}}}showMining(t){this.text=["mining",`${Math.floor(t)}/1000 ore`]}holdFull(){this.text=["cargo","hold full",null,"time to","rest"]}showDrivingControls(){this.text=["Ⓩ forward","Ⓧ reverse","←→↑↓ turn",null,"Ⓒ cancel"]}miningInstructions(){this.text=["carefully approach","an asteroid",null,null,null,"to extract ores"]}showShipState(t){t.state===u.Accelerating?this.text=["accelerating"]:t.state===u.Braking&&(this.text=["braking"])}interactConsole(){this.text=["Ⓒ drive"]}interactBed(){this.text=["Ⓒ rest"]}interactCalendar(){this.text=["Ⓒ check calendar"]}interactHatchClosed(){this.text=["Ⓒ open hatch"]}needScrewdriver(){this.text=["you need a","screwdriver","for that"]}toggleHardMode(t){this.text=t?["Ⓒ re-enable","auto-braking",null,"mind your","velcity"]:["Ⓒ disable","auto-braking",null,"caution!","(hard mode)"]}calendarText(t){this.text=["kuiper shift","contract",null,`day ${t}`]}interactPlant(t){switch(t.state()){case b.Happy:this.text=["the plant","looks happy"];break;case b.Thirsty:this.text=["the plant","looks thirsty"]}this.text=[...this.text,null,"Ⓒ water","Ⓧ move"]}holdingPlant(t){this.text=["Ⓧ place"],t&&this.text.push("↑↓ move")}collided(t){if(p.elapsed%.5<2/6){const e=`${Math.floor(100*t.hullIntegrity)}%`;this.text=["collision","detected",null,"hull: "+e]}else this.text=[]}}class D{constructor(t,e){this.speed=e,this.value=t,this._displayValue=t}get displayValue(){return this._displayValue}get isMoving(){return this.displayValue!==this.value}update(){this._displayValue<this.value?(this._displayValue+=p.deltaTime*this.speed,this._displayValue=Math.min(this._displayValue,this.value)):this._displayValue>this.value&&(this._displayValue-=p.deltaTime*this.speed,this._displayValue=Math.max(this._displayValue,this.value))}}var F=new class{constructor(){this.source=null,this.buffer=null,this.background=null,this.oneShot=null,this.playing=null,this.ctx=new e,this.gain=this.ctx.createGain(),this.gain.connect(this.ctx.destination),this.loadAudioSprite()}unlock(){const t=()=>{"suspended"===this.ctx.state&&this.ctx.resume()};window.addEventListener("click",t),window.addEventListener("keydown",t)}async loadAudioSprite(){this.buffer=await fetch("/tiny-asteroid-miner/assets/audiosprite.16983004.mp3").then((t=>t.arrayBuffer())).then((t=>this.ctx.decodeAudioData(t)))}update(){const t=this.oneShot||this.background,e=!this.oneShot;if(t&&null!==this.playing){const[i,s]=t;this.volume(s),this.playing!==i&&(this.disconnectSource(),this.play(i,e))}else if(t){const[i,s]=t;this.volume(s),this.play(i,e)}else this.playing&&this.disconnectSource()}playOneShot(t,e=1){this.oneShot=[t,e]}setBackground(t,e=1){this.background=null===t?null:[t,e]}play(t,e=!1){if(!this.buffer)return;this.source=this.ctx.createBufferSource(),this.source.buffer=this.buffer,this.source.connect(this.gain);const[i,s]=n[t];e?(this.source.loop=!0,this.source.loopStart=i,this.source.loopEnd=s,this.source.start(0,i)):(this.source.start(0,i,s-i),this.source.addEventListener("ended",(()=>{this.oneShot=null,this.disconnectSource()}))),this.playing=t}volume(t){this.gain.gain.setValueAtTime(t,this.ctx.currentTime)}disconnectSource(){null!==this.source&&(this.source.disconnect(),this.source=null,this.playing=null)}};function N(e,s,h,a,r=t.Left,n=i.Top){const l=p.textWidth(e)+2;return r===t.Center?s-=l/2:r===t.Right&&(s-=l,n===i.Middle?s-=3:n===i.Bottom&&(s-=7)),p.rect(s,h,l,7,a?v:y),p.text(e,s+1,h+1,a?y:v),l}class U{constructor({credits:t,hull:e,ore:i}){this.onContinue=()=>{},this.step=0,this.stepTimer=0,this.ore=new D(i,200),this.credits=new D(t,20),this.hull=new D(e,.2)}get isMoving(){return this.hull.isMoving||this.ore.isMoving||this.credits.isMoving}update(){if(this.isMoving||(this.stepTimer+=p.deltaTime),this.step<3&&this.stepTimer>=1.5){switch(0===this.step&&(this.hull.value>=1||this.ore.value<=0)&&this.step++,1===this.step&&this.ore.value<=0&&this.step++,this.step){case 0:this.repairHull();break;case 1:this.sellOre()}this.step++,this.stepTimer=0,F.playOneShot("blip-0")}this.ore.update(),this.credits.update(),this.hull.update(),this.step>=3&&p.keyPressed("c")&&this.onContinue({hull:this.hull.value,ore:this.ore.value,credits:this.credits.value})}repairHull(){const t=this.hull.value,e=this.ore.value;1e3*(1-t)>=e?(this.hull.value+=e/1e3,this.ore.value=0):(this.ore.value-=1e3*(1-t),this.hull.value=1)}sellOre(){this.credits.value+=this.ore.value/10,this.ore.value=0}draw(){const e=Math.floor(this.ore.displayValue)+" ore",s=Math.floor(this.credits.displayValue)+"¢",h=p.width-8;let a=8;if(p.width,N(e,8,a,this.ore.isMoving,t.Left),N(s,h,a,this.credits.isMoving,t.Right),1===this.step){a+=11;const e=p.elapsed%1>2/3;this.isMoving&&!e&&(N("repairing",p.width/2,a,!1,t.Center),N("hull damage",p.width/2,a+6,!1,t.Center)),a+=15;const i=(h-8-2)*this.hull.displayValue;p.rect(8,a,h-8,7,y),p.rect(9,a+1,i,5,v);N(Math.floor(100*this.hull.displayValue)+"%",p.width/2,a,!1,t.Center)}else if(2===this.step){if(a+=18,this.isMoving){const e=p.elapsed%.5>1/4;N("transmitting",p.width/2,a,e,t.Center)}}else 3===this.step&&this.stepTimer%2<4/3&&N("Ⓒ continue",p.width/2,p.height/2,!0,t.Center,i.Middle)}}class H{constructor({credits:t},e,i){this.onContinue=()=>{},this.selected=0,this.purchases={plants:0,calendar:!1,screwdriver:!1},this.flashPriceTimer=0,this.flashPriceItem=0,this.credits=new D(t,100),this.hasCalendar=e,this.hasScrewdriver=i}update(){if(this.credits.update(),this.flashPriceTimer>0&&(this.flashPriceTimer-=p.deltaTime),p.keyPressed("down")&&this.moveSelect(!0),p.keyPressed("up")&&this.moveSelect(!1),p.keyPressed("c"))switch(this.selected){case 0:this.tryBuyItem(30,0)&&this.purchases.plants++;break;case 1:this.tryBuyItem(80,1)&&(this.purchases.calendar=!0,this.moveSelect(!0));break;case 2:this.tryBuyItem(100,2)&&(this.purchases.screwdriver=!0,this.moveSelect(!0));break;case 3:this.onContinue(this.credits.value,this.purchases)}}draw(){let e=2;const i=p.width-6;N("buy",7,e,!1);N(`${Math.floor(this.credits.displayValue)}¢`,i,e,this.flashPriceTimer<=0||this.flash(),t.Right),e+=10,N("plant",7,e,0===this.selected),N("-30¢",i,e,this.flash(0),t.Right),0===this.selected&&this.drawArrow(7,e+3),e+=8,this.hasCalendar||this.purchases.calendar||(N("calendar",7,e,1===this.selected),N("-80¢",i,e,this.flash(1),t.Right),1===this.selected&&this.drawArrow(7,e+3)),e+=8,this.hasScrewdriver||this.purchases.screwdriver||(N("screwdriver",7,e,2===this.selected),N("-100¢",i,e,this.flash(2),t.Right),2===this.selected&&this.drawArrow(7,e+3)),e+=10,N("continue",7,e,3===this.selected),3===this.selected&&this.drawArrow(7,e+3),e+=8}moveSelect(t){F.playOneShot("blip-0");do{this.selected+=t?1:-1,this.selected=(this.selected+4)%4}while((this.hasCalendar||this.purchases.calendar)&&1===this.selected||(this.hasScrewdriver||this.purchases.screwdriver)&&2===this.selected)}tryBuyItem(t,e){return this.credits.value>=t?(this.credits.value-=t,F.playOneShot("blip-0"),!0):(F.playOneShot("notice"),this.flashPriceItem=e,this.flashPriceTimer=.5,!1)}flash(t){return(void 0===t||this.flashPriceItem===t)&&this.flashPriceTimer>0&&this.flashPriceTimer%.2<.1}drawArrow(t,e){const i=p.elapsed%2>1?0:-1;p.pixel(t-2+i,e,v),p.pixel(t-3+i,e+1,v),p.pixel(t-3+i,e-1,v),p.pixel(t-3+i,e,y)}}class E{constructor({credits:t,ore:e,hull:i},s,h){this.onContinue=()=>{},this.screen=new U({credits:Math.floor(t),ore:Math.floor(e),hull:Math.floor(100*i)/100}),this.screen.onContinue=t=>{F.playOneShot("blip-0"),this.screen=new H(t,s,h),this.screen.onContinue=(e,i)=>{t.credits=e,this.onContinue(t,i)}}}update(){this.screen.update()}draw(){this.screen.draw()}}const V=[[1/65,33/65,9/65,41/65,3/65,35/65,11/65,43/65],[49/65,17/65,57/65,25/65,51/65,19/65,59/65,27/65],[.2,45/65,5/65,37/65,15/65,47/65,7/65,.6],[61/65,29/65,53/65,21/65,63/65,31/65,55/65,23/65],[4/65,36/65,12/65,44/65,2/65,34/65,10/65,42/65],[.8,20/65,60/65,28/65,50/65,18/65,58/65,.4],[16/65,48/65,8/65,40/65,14/65,46/65,6/65,38/65],[64/65,32/65,56/65,24/65,62/65,30/65,54/65,22/65]];function L(t,e,i){return V[e%8][t%8]<i}function j(t,e,i=null,s=!1){for(let h=0;h<p.width;h++)for(let a=0;a<p.height;a++){let r=t;if(null!==i){const[e,n]=i,l=h-e,o=a-n,d=Math.sqrt(l*l+o*o),c=40;r=s?(t*(p.width+c)-d-c)/c:(d+c-t*(p.width+c))/c}L(h,a,r)&&p.pixel(h,a,e)}}const Y=new(h||a);let q=0;function z(t=!1){const e=[],i=[],s=new f,h={asteroids:e,stars:i,particles:[],plants:[],ship:s,miner:new x,gui:new B,menu:null,isDriving:!1,isShowingControls:!1,shouldShowControls:!0,showInstructionsTimer:0,showDamageTimer:0,deadTimer:0,menuFadeInTimer:0,dreamBackdrop:1,isAsleep:!1,isTitleScreen:!0,titleFadeOut:!1,titleFadeOutTimer:t?1:0,holdFullBeepTimer:0,miningParticleTimer:0,hasCalendar:!1,isCheckingCalendar:!1,day:128,hasScrewdriver:!1,isHatchOpen:!1,isHardMode:!1};for(let a=0;a<100;a++){const t=[20*Math.random()-10,20*Math.random()-10,20*Math.random()-10];l.magSq(t)<2.25?a--:e.push(new T(t))}for(let a=0;a<100;a++){let t=[Math.random()-.5,Math.random()-.5,Math.random()-.5];t=l.normalize(t),t=l.scale(t,1e7),i.push([...t,Math.random()])}return s.onDamage=()=>{h.showDamageTimer=2,F.playOneShot("crash")},h}s({showFps:!1,dimensions:[84,48],maxScale:6,crop:!0,spritesheet:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFQAAABVCAYAAADXN8NkAAAAAXNSR0IArs4c6QAAA1RJREFUeJztnctx4zAMhmGNCkgZaWEPPrkDl+AZd+FjushMSkgHOe3BLbgMd6A9ZKGlIJAERcirmP83k3FiyXp8AvgS5ewOx/1Af/n6/L0jUE8oFVTCMiHVh44IMj3ZXe83yHSkz61wOZ2JiOjt4331g1kLPgeiuvOwuJhEaLhjYCcUPAplmWg6lcH1D0vtwoWQWY50NilD2TbE2tBaR6NQDlmUozZkqjOdujYwodX2Y4QiMsvRmmOTMhRlp53QVViWIuWdgVBnINQZCHUGQp2BUGcg1BkIdQZCnYFQZzoi9OM9GSMU/XgfkPLOjEJxb96Hjuhn3yLeGkh5ZyDUGQh1BkKdgVBnINQZCHUGQiuRHaLs/NAWKe01hh2jzQq1nBQP6IRzXH+9vFYN8sTmLFnZpFDLSV1OZzoc9wNL9RyCrOmKz6YzPnIYLxWFbx/vSUnh8svpPEr4+nx1PcbchZLyJ9MZ+apbd1YjPxWFpdHGx+49yGPZplxnEqElByRTbgleArjcLIlOLXA8slMtQy1XZklEr0HN/sNzjJ1LabbMhLLM8FXuXDug/4XXMcS2k6sYJb22gnwNf3+kxC1cMEZOrpUBx8witPSKrIWWKakTiX0+937uoTBtP1rAMbvr/TasUUNqB2Ctja3Hk1pPW2YJCCl7cS2/RkrLE5BXNhVBpa8WNMHegVT0WE1ps6o2EmNlurXo8XjGc3Etv6XZIyUpn8Lj2StZXsuWT7RSskTTI7BUOHL9Uh7eejkc90PYyK39uyVmXa2wO7l08CJc1tqcqUUj9rm0XLsZtmUWCc0JKy0Hnx6UoWAzqA+AEs0rk9rlrTArQy3joDXLn52JUMisRx0PjVG7vAUwc8QZCF2TXPvR0rZsvf3ZXe+3QYrk96732+THssFWm0sMUn4NwigNIzGM0tZT2couJar19F1CT+Qzvwh80xNBnieIUGcQoc70RN+VD99Lkt8hmpr2p33faKySa6aC077H3vK75bOxdZ6Z8XvsPSOoFXkaHdG/lF+yAe1iaKP5raS82vVkwdo9etnv10Rpt0NajlozkDQHgyPORB/8ijWXYuUhxgQSaHJKmlep956daMq3KMODaC2v1cw5ybgIEaGyycRoXUz8T7spfwBzEoYPZyn+xwAAAABJRU5ErkJggg==",font:{src:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAU8AAAAFCAYAAADFeW5MAAAAAXNSR0IArs4c6QAAAgJJREFUWIXNV9uNAjEMBCqgDFqg/w9aoAw64H4u0miYsSfJcjpLaFnj58Sxzen0S4/X831qaMiwrNNF/uP1fI9P6qfiOVvMdzF/g5J8XR6drsqj8pHYS3g7GKS/o1/Mcwa/Hd4qphzPru5MnsrvUbg4fzN5dL0i0a38/gfehUHrkpx53q+3M9rkdwbK6Q1dlnVySo/5RzfTJF/l8369nZWeyk0Ry444kOfspTx3uRSPY+ECVOeoYhzvKD/sqzpIa0PJdfgrTBWN35O6TyhtsowT+mXsEvxcDe3kskrqLDAOrK+Uh7Y4V+QNfbY3eLZ5qiTUkxN04LpL821SF85NRaXrJvMKucY0sw3s6Kf2krjVYHBNyA00toU2HPZJ056h1Ifi79RFErMa/DP3KMXlr5YLfHdLTRJfpdM1fFWTVU2pwf+xebppicWsnuO7mlwsn246R5ID0PlmsJKNY+fyoh/3PsMb/NRvYi9psupSVw2wihu3gWSL2xnMqQ+n28m4uNKYjzzfSk7V/VEN1C0wrjmprZ/tVb7wu+pNzoYaUtU/kAv+UAHgNs9k40wC56CZn4KYHrhrEjsXopNz+asDTjfHHQxWsaqaXzd8KozxrxEW/srwmqmhpPZnNvmuIXT6M4RYdRsZynUNaDVmty3jc5bwjHgpw/pSPIyh08XmyEufkvsB6SHWY2vvZioAAAAASUVORK5CYII=",w:5,h:5,letters:"!\"#¢% '()[]*+,-./0123456789:;<=>?@abcdefghijklmnopqrstuvwxyz←→↑↓ⓏⓍⒸ"},loop:function(){const{ship:e,miner:i,plants:s,asteroids:h,particles:a,stars:n,gui:o}=X;p.clear(X.isTitleScreen||X.dreamBackdrop<1?v:y),o.text=[];let c=null,u=null,m=!1;if(X.isTitleScreen)e.rot=d.yaw(.05*p.elapsed),e.pos=d.mult3x3vec(e.rot,[0,0,-5]),p.keyPressed("c")&&(X.titleFadeOut=!0),X.titleFadeOut?(X.titleFadeOutTimer+=p.deltaTime,X.titleFadeOutTimer>1&&(X.isTitleScreen=!1,e.pos=[0,0,0],F.playOneShot("wake"))):X.titleFadeOutTimer>0&&(X.titleFadeOutTimer-=p.deltaTime);else if(X.dreamBackdrop>0&&!X.isAsleep)X.dreamBackdrop-=p.deltaTime,X.dreamBackdrop<.3?(i.moveRightOverride=!0,i.hasControl=!1,i.update()):i.x=4;else if(X.isAsleep)X.dreamBackdrop<1?X.dreamBackdrop+=p.deltaTime:(X.menu.update(),e.rot=d.yaw(.05*p.elapsed),e.pos=d.mult3x3vec(e.rot,[0,0,-5]),X.menuFadeInTimer+=p.deltaTime);else{e.hasControl=X.isDriving,e.isBrakingEnabled=!X.isHardMode,i.hasControl=!X.isDriving,i.moveRightOverride=!1,e.update(),i.update(),s.forEach((t=>t.update())),a.forEach((t=>t.update()));for(let e=0;e<a.length;e++)a[e].isDead&&(a.splice(e,1),e--);if(e.ore>300&&(X.shouldShowControls=!1),e.hullIntegrity>0)for(let i=0;i<h.length;i++){const t=w(e.pos,e.forward,h[i].pos,h[i].radius+.1);null!==t&&(null===c||t<c)&&(c=t,u=h[i]);const s=l.magSq(l.sub(h[i].pos,e.pos)),r=h[i].radius;if(s<r*r&&(e.collideWithAsteroid(h[i]),e.hullIntegrity<=0))for(let i=0;i<10;i++)a.push(new R(e.pos))}const t=X.showDamageTimer<=0&&e.ore<1e3,r=null!==c&&c<=e.miningDistance;if(m=t&&r,m){if(e.mine(u),u.radius<=0&&(F.playOneShot("thud"),h.splice(h.indexOf(u),1)),X.miningParticleTimer+=p.deltaTime,X.miningParticleTimer>.05){X.miningParticleTimer=0;const t=l.add(e.pos,l.scale(e.forward,c));for(let e=0;e<3;e++)a.push(new R(t))}o.showMining(e.ore)}else X.miningParticleTimer=0;if(X.isDriving)X.isShowingControls&&o.showDrivingControls(),X.isShowingControls&&(p.keyPressed("z")||p.keyPressed("x"))&&(X.isShowingControls=!1,X.showInstructionsTimer=4),X.showInstructionsTimer>0&&(o.miningInstructions(),X.showInstructionsTimer-=p.deltaTime),o.text.length||o.showShipState(e),e.ore>=1e3&&(o.holdFull(),X.holdFullBeepTimer-=p.deltaTime,X.holdFullBeepTimer<=0&&(F.playOneShot("notice"),X.holdFullBeepTimer=3)),p.keyPressed("c")&&(X.isDriving=!1,F.playOneShot("off"));else if(s.forEach((t=>{t.highlight=!1})),i.heldPlant)o.holdingPlant(i.heldPlant.possiblePlacements.length>1),p.keyPressed("x")&&(i.heldPlant=null,F.playOneShot("thud"));else{const t=s.filter((t=>Math.abs(i.x-t.x)<3));if(t.length){let e=t[0];for(let s=1;s<t.length;s++){Math.abs(t[s].x-i.x)<Math.abs(e.x-i.x)&&(e=t[s])}e.highlight=!0,o.interactPlant(e),p.keyPressed("c")&&(i.wateringPlant=e),p.keyPressed("x")&&(i.heldPlant=e,F.playOneShot("blip-0"))}else i.x>36&&i.x<50&&(o.interactConsole(),p.keyPressed("c")&&(X.isDriving=!0,F.playOneShot("on"),X.shouldShowControls&&(X.isShowingControls=!0))),X.hasCalendar&&i.x>15&&i.x<=19?X.isCheckingCalendar?o.calendarText(X.day):(o.interactCalendar(),p.keyPressed("c")&&(X.isCheckingCalendar=!0,F.playOneShot("blip-0"))):X.isCheckingCalendar=!1,i.x>32&&i.x<=36?X.isHatchOpen?X.hasScrewdriver?(o.toggleHardMode(X.isHardMode),p.keyPressed("c")&&(X.isHardMode=!X.isHardMode,F.playOneShot("blip-0"))):o.needScrewdriver():(o.interactHatchClosed(),p.keyPressed("c")&&(X.isHatchOpen=!0,F.playOneShot("blip-0"))):X.isHardMode||(X.isHatchOpen=!1),i.x<11&&(o.interactBed(),p.keyPressed("c")&&(X.menu=new E({hull:X.ship.hullIntegrity,ore:X.ship.ore,credits:X.ship.credits},X.hasCalendar,X.hasScrewdriver),X.menu.onContinue=(t,e)=>{X.ship.hullIntegrity=t.hull,X.ship.ore=t.ore,X.ship.credits=t.credits;for(let i=0;i<e.plants;i++)X.plants.push(new O(X.plants));e.calendar&&(X.hasCalendar=!0,function(){for(const t of X.plants){const e=t.x-17;Math.abs(e)<2&&(t.x+=3*e/Math.abs(e))}}()),e.screwdriver&&(X.hasScrewdriver=!0),X.isAsleep=!1,X.day++,F.playOneShot("wake")},X.isAsleep=!0,X.menuFadeInTimer=0,X.holdFullBeepTimer=0,F.playOneShot("sleep")))}X.showDamageTimer>0&&(X.showDamageTimer-=p.deltaTime,o.collided(e))}if(X.isTitleScreen||X.dreamBackdrop<1||X.isAsleep){const t=new g(e.pos,e.rot,p.width/2);for(const e of n){const[i,s,h]=t.projectToScreen(e);h>0&&p.pixel(i,s,y)}const l=Math.max(0,X.showDamageTimer*X.showDamageTimer);q+=p.deltaTime*l*4;const d=Y.noise2D(1e5,q)*(1+.5*l),u=Y.noise2D(1e6,q)*(1+.5*l);if(p.center(p.width/2+d,p.height/2+u),h.forEach((e=>e.draw(t,X.isAsleep))),a.forEach((e=>e.draw(t))),p.center(p.width/2,p.height/2),e.hullIntegrity>0&&!X.isTitleScreen&&!X.isAsleep){let t;if(X.isDriving&&function(t,e,i){const s=Math.min(16*Math.log(t.speed+1),26);if(s>0&&p.line(3,35,3,35-s,y),null!==e&&e<10){const i=Math.min(16*Math.log(e+1)-1,23),s=e<t.miningDistance;p.line(p.width-4,31,p.width-4,31-i,s&&p.frame%2==0?v:y)}const h=16*Math.log(t.miningDistance+1)-1;p.line(p.width-7,31-h,p.width-6,31-h,y);const[a,r]=[p.width/2,p.height/2];i&&(p.line(0,p.height,a,r,y),p.line(0,p.height-1,a,r-1,v),p.line(p.width,p.height,a,r,y),p.line(p.width,p.height-1,a,r-1,v));const n=null!==e&&e<10?v:y;p.line(a-1,r-1,a+1,r-1,n),p.line(a,r-2,a,r,n)}(e,c,m),p.sprite(0,0,r.frame[0]),X.hasCalendar&&p.sprite(16,41,r.calendar[0]),t=X.isHatchOpen&&X.isHardMode&&X.hasScrewdriver?1:X.isHatchOpen&&X.hasScrewdriver?p.elapsed%.4<.2?1:2:0,p.sprite(28,38,r.hatch[t]),X.isDriving){p.sprite(39,36,r.screen[0]);for(let t=41;t<46;t++)Y.noise3D(t,0,.25*p.elapsed)>.5&&p.pixel(t,37,v),Y.noise3D(t,1,.25*p.elapsed)>.5&&p.pixel(t,39,v)}s.forEach((t=>t.draw())),i.draw(),o.draw()}}if(X.isTitleScreen){let e=Math.round(Math.cos(p.elapsed)),i=Math.round(Math.sin(p.elapsed+.2));p.circle(p.width/2+e,14+i,18,y);const s=r.title[0];p.sprite(p.width/2-s.w/2,10,s);for(let t=25+e;t<55;t++)Y.noise3D(.1*t,0,.5*p.elapsed)<.5&&p.pixel(t,8,v);for(let t=33;t<59+e;t++)Y.noise3D(.1*t,1,.5*p.elapsed)<.5&&p.pixel(t,23,v);if(p.elapsed%2<4/3){const e=p.textWidth("press Ⓒ to start");p.rect(p.width/2-e/2,p.height-10,e+2,7,v),p.text("press Ⓒ to start",p.width/2,p.height-9,{color:y,align:t.Center})}}else X.isAsleep&&X.dreamBackdrop>=1&&X.menu.draw();X.dreamBackdrop>0&&X.dreamBackdrop<1&&j(1-X.dreamBackdrop,y,[8,p.height-4]);X.menuFadeInTimer>0&&X.menuFadeInTimer<.5&&j(1-2*X.menuFadeInTimer,y);X.isTitleScreen&&X.titleFadeOutTimer>0&&j(X.titleFadeOutTimer,y);e.hullIntegrity<=0&&(X.deadTimer+=.5*p.deltaTime,X.deadTimer>1&&j((X.deadTimer-1)/2,y,[p.width/2,p.height/2],!0),X.deadTimer>3&&(X=z(!0)));if(F.setBackground(null),X.isTitleScreen)F.setBackground("theme",.2);else if(i.wateringPlant)F.setBackground("laser",.5);else if(m)F.setBackground("laser",.5);else if(e.isMoving&&e.hullIntegrity>0){const t=Math.min(l.magSq(e.vel),3);F.setBackground("rumble",t)}F.update()}});let X=z();
